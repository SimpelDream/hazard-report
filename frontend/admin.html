<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>隐患上报管理后台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden {
      display: none;
    }
    
    /* 响应式表格样式 */
    @media (max-width: 768px) {
      .responsive-table thead {
        display: none;
      }
      .responsive-table tbody tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        padding: 0.5rem;
      }
      .responsive-table tbody td {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem;
        text-align: right;
        border-bottom: 1px solid #e5e7eb;
      }
      .responsive-table tbody td:last-child {
        border-bottom: none;
      }
      .responsive-table tbody td:before {
        content: attr(data-label);
        float: left;
        font-weight: bold;
        text-align: left;
      }
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- 登录页面 -->
  <div id="login-page" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg max-w-md w-full">
      <h2 class="text-xl md:text-2xl font-bold mb-6 text-center">隐患上报管理后台</h2>
      <div id="login-error" class="mb-4 text-red-500 text-center hidden"></div>
      <form id="login-form" class="space-y-4">
        <div>
          <label for="username" class="block mb-1 font-medium">用户名</label>
          <input type="text" id="username" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div>
          <label for="password" class="block mb-1 font-medium">密码</label>
          <input type="password" id="password" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition duration-300">
          登录
        </button>
      </form>
    </div>
  </div>

  <!-- 主页面内容 -->
  <div id="main-content" class="hidden">
    <div class="container mx-auto px-4 py-4 max-w-6xl">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-2xl md:text-3xl font-bold">隐患上报管理后台</h1>
        <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 w-full md:w-auto">
          退出登录
        </button>
      </div>
      
      <div class="mb-6 bg-white p-4 rounded shadow">
        <h2 class="text-lg md:text-xl font-semibold mb-4">筛选条件</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <label class="block mb-1">项目</label>
            <select id="project-filter" class="w-full p-2 border rounded">
              <option value="">所有项目</option>
            </select>
          </div>
          <div>
            <label class="block mb-1">隐患分类</label>
            <select id="category-filter" class="w-full p-2 border rounded">
              <option value="">所有分类</option>
            </select>
          </div>
          <div>
            <label class="block mb-1">上报人</label>
            <input type="text" id="reporter-filter" class="w-full p-2 border rounded" placeholder="输入上报人姓名">
          </div>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1">起始日期</label>
            <input type="date" id="start-date" class="w-full p-2 border rounded">
          </div>
          <div>
            <label class="block mb-1">结束日期</label>
            <input type="date" id="end-date" class="w-full p-2 border rounded">
          </div>
        </div>
        <div class="mt-4 flex justify-end">
          <button id="search-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full md:w-auto">搜索</button>
        </div>
      </div>
      
      <div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
        <h2 class="text-xl md:text-2xl font-semibold">上报列表</h2>
        <div class="flex items-center gap-2">
          <button id="export-btn" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
            导出Excel
          </button>
          <span class="mr-2">每页显示:</span>
          <select id="page-size" class="border rounded p-1">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>
      
      <div class="bg-white shadow rounded overflow-x-auto">
        <table class="min-w-full responsive-table">
          <thead>
            <tr class="bg-gray-200">
              <th class="py-2 px-4 text-left">ID</th>
              <th class="py-2 px-4 text-left">项目</th>
              <th class="py-2 px-4 text-left">上报人</th>
              <th class="py-2 px-4 text-left">联系电话</th>
              <th class="py-2 px-4 text-left">隐患分类</th>
              <th class="py-2 px-4 text-left">发现时间</th>
              <th class="py-2 px-4 text-left">地点</th>
              <th class="py-2 px-4 text-left">上报时间</th>
              <th class="py-2 px-4 text-left">状态</th>
              <th class="py-2 px-4 text-left">操作</th>
            </tr>
          </thead>
          <tbody id="reports-table">
            <!-- 数据将通过JavaScript填充 -->
          </tbody>
        </table>
      </div>
      
      <div class="mt-4 flex flex-col md:flex-row justify-between items-center gap-2">
        <div>
          <span>总记录: <span id="total-count">0</span></span>
        </div>
        <div class="flex items-center">
          <button id="prev-page" class="bg-gray-200 px-3 py-1 rounded mr-2 hover:bg-gray-300 disabled:opacity-50">上一页</button>
          <span>第 <span id="current-page">1</span> / <span id="total-pages">1</span> 页</span>
          <button id="next-page" class="bg-gray-200 px-3 py-1 rounded ml-2 hover:bg-gray-300 disabled:opacity-50">下一页</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 详情模态框 -->
  <div id="report-modal" class="fixed inset-0 hidden z-50 overflow-y-auto">
    <div class="fixed inset-0 bg-black opacity-50"></div>
    <div class="relative bg-white mx-auto my-10 p-4 md:p-6 rounded shadow-lg max-w-md md:max-w-2xl w-full md:w-3/4 lg:w-2/3">
      <h2 class="text-xl font-bold mb-4">隐患详情</h2>
      <div id="report-details" class="overflow-y-auto max-h-[70vh]">
        <!-- 详情将通过JavaScript填充 -->
      </div>
      <div class="mt-6 flex justify-end">
        <button id="close-modal" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">关闭</button>
      </div>
    </div>
  </div>
  
  <div id="loading" class="loading hidden">
    <div class="loading-spinner"></div>
  </div>

  <script>
    // 用户认证相关
    const AUTH_KEY = 'hazard_report_auth';
    const API_BASE_URL = 'http://localhost:3000/api';
    
    // API 调用相关配置
    const API_CONFIG = {
      BASE_URL: 'http://localhost:3000/api',
      TIMEOUT: 30000, // 30秒超时
      MAX_RETRIES: 3, // 最大重试次数
      RETRY_DELAY: 1000, // 重试延迟（毫秒）
      CSRF_HEADER: 'X-CSRF-Token'
    };
    
    // 状态更新相关配置
    const STATUS_CONFIG = {
      UPDATE_TIMEOUT: 5000, // 5秒超时
      MAX_RETRIES: 3, // 最大重试次数
      RETRY_DELAY: 1000, // 重试延迟（毫秒）
      STATUSES: {
        PENDING: '进行中',
        RESOLVED: '已整改'
      }
    };

    // 状态更新锁
    const statusUpdateLocks = new Map();

    // 状态更新日志
    const statusUpdateLogs = new Map();

    // 添加状态更新日志
    function addStatusUpdateLog(reportId, oldStatus, newStatus, success, error = null) {
      const timestamp = new Date().toISOString();
      const log = {
        timestamp,
        oldStatus,
        newStatus,
        success,
        error: error?.message || null
      };

      if (!statusUpdateLogs.has(reportId)) {
        statusUpdateLogs.set(reportId, []);
      }
      statusUpdateLogs.get(reportId).push(log);
    }

    // 通用 API 调用函数
    async function callApi(endpoint, options = {}, retryCount = 0) {
      try {
        const token = localStorage.getItem(AUTH_KEY);
        const headers = {
          'Content-Type': 'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
          ...options.headers
        };

        const response = await fetch(`${API_CONFIG.BASE_URL}${endpoint}`, {
          ...options,
          headers
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        if (retryCount < API_CONFIG.MAX_RETRIES) {
          await new Promise(resolve => setTimeout(resolve, API_CONFIG.RETRY_DELAY));
          return callApi(endpoint, options, retryCount + 1);
        }
        throw error;
      }
    }

    // 登录处理
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        showLoading();
        const response = await callApi('/admin/login', {
          method: 'POST',
          body: JSON.stringify({ username, password })
        });

        if (response.success) {
          localStorage.setItem(AUTH_KEY, response.data.token);
          document.getElementById('login-page').classList.add('hidden');
          document.getElementById('main-content').classList.remove('hidden');
          loadReports();
        } else {
          showError('登录失败：' + response.error);
        }
      } catch (error) {
        showError('登录失败：' + error.message);
      } finally {
        hideLoading();
      }
    });

    // 加载报告列表
    async function loadReports(page = 1) {
      try {
        showLoading();
        const limit = parseInt(document.getElementById('page-size').value);
        const project = document.getElementById('project-filter').value;
        const category = document.getElementById('category-filter').value;
        const reporter = document.getElementById('reporter-filter').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        const queryParams = new URLSearchParams({
          page,
          limit,
          ...(project && { project }),
          ...(category && { category }),
          ...(reporter && { reporter }),
          ...(startDate && { startDate }),
          ...(endDate && { endDate })
        });

        const response = await callApi(`/admin/reports?${queryParams}`);

        if (response.success) {
          renderReports(response.data.reports);
          updatePagination(response.data.total, response.data.pages, page);
        } else {
          showError('加载报告失败：' + response.error);
        }
      } catch (error) {
        showError('加载报告失败：' + error.message);
      } finally {
        hideLoading();
      }
    }

    // 渲染报告列表
    function renderReports(reports) {
      const tbody = document.getElementById('reports-table');
      tbody.innerHTML = '';

      reports.forEach(report => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="ID">${report.id}</td>
          <td data-label="项目">${report.project}</td>
          <td data-label="上报人">${report.reporter}</td>
          <td data-label="联系电话">${report.phone}</td>
          <td data-label="隐患分类">${report.category || '-'}</td>
          <td data-label="发现时间">${new Date(report.foundAt).toLocaleString()}</td>
          <td data-label="地点">${report.location}</td>
          <td data-label="上报时间">${new Date(report.createdAt).toLocaleString()}</td>
          <td data-label="状态">
            <select class="status-select" data-id="${report.id}" ${statusUpdateLocks.get(report.id) ? 'disabled' : ''}>
              <option value="进行中" ${report.status === '进行中' ? 'selected' : ''}>进行中</option>
              <option value="已整改" ${report.status === '已整改' ? 'selected' : ''}>已整改</option>
            </select>
          </td>
          <td data-label="操作">
            <button class="view-btn bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600" data-id="${report.id}">
              查看详情
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // 绑定状态更新事件
      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', handleStatusUpdate);
      });

      // 绑定查看详情事件
      document.querySelectorAll('.view-btn').forEach(button => {
        button.addEventListener('click', handleViewDetails);
      });
    }

    // 更新分页控件
    function updatePagination(total, pages, currentPage) {
      document.getElementById('total-count').textContent = total;
      document.getElementById('current-page').textContent = currentPage;
      document.getElementById('total-pages').textContent = pages;

      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');

      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= pages;

      prevBtn.onclick = () => loadReports(currentPage - 1);
      nextBtn.onclick = () => loadReports(currentPage + 1);
    }

    // 处理状态更新
    async function handleStatusUpdate(event) {
      const select = event.target;
      const reportId = select.dataset.id;
      const newStatus = select.value;
      const oldStatus = select.options[select.selectedIndex - 1]?.value || '进行中';

      if (statusUpdateLocks.get(reportId)) {
        return;
      }

      try {
        statusUpdateLocks.set(reportId, true);
        select.disabled = true;

        const response = await callApi(`/admin/reports/${reportId}/status`, {
          method: 'PATCH',
          body: JSON.stringify({ status: newStatus })
        });

        if (response.success) {
          addStatusUpdateLog(reportId, oldStatus, newStatus, true);
        } else {
          throw new Error(response.error);
        }
      } catch (error) {
        addStatusUpdateLog(reportId, oldStatus, newStatus, false, error);
        select.value = oldStatus;
        showError(`更新状态失败：${error.message}`);
      } finally {
        statusUpdateLocks.set(reportId, false);
        select.disabled = false;
      }
    }

    // 处理查看详情
    async function handleViewDetails(event) {
      const reportId = event.target.dataset.id;
      const modal = document.getElementById('report-modal');
      const details = document.getElementById('report-details');

      try {
        showLoading();
        const response = await callApi(`/admin/reports/${reportId}`);

        if (response.success) {
          const report = response.data;
          details.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p><strong>ID：</strong>${report.id}</p>
                <p><strong>项目：</strong>${report.project}</p>
                <p><strong>上报人：</strong>${report.reporter}</p>
                <p><strong>联系电话：</strong>${report.phone}</p>
                <p><strong>隐患分类：</strong>${report.category || '-'}</p>
              </div>
              <div>
                <p><strong>发现时间：</strong>${new Date(report.foundAt).toLocaleString()}</p>
                <p><strong>地点：</strong>${report.location}</p>
                <p><strong>状态：</strong>${report.status}</p>
                <p><strong>上报时间：</strong>${new Date(report.createdAt).toLocaleString()}</p>
              </div>
            </div>
            <div class="mt-4">
              <p><strong>描述：</strong></p>
              <p class="whitespace-pre-wrap">${report.description}</p>
            </div>
            ${report.images ? `
              <div class="mt-4">
                <p><strong>图片：</strong></p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                  ${report.images.split(',').map(url => `
                    <img src="${url}" alt="隐患图片" class="w-full h-48 object-cover rounded">
                  `).join('')}
                </div>
              </div>
            ` : ''}
          `;
          modal.classList.remove('hidden');
        } else {
          showError('加载详情失败：' + response.error);
        }
      } catch (error) {
        showError('加载详情失败：' + error.message);
      } finally {
        hideLoading();
      }
    }

    // 导出报告
    document.getElementById('export-btn').addEventListener('click', async () => {
      try {
        showLoading();
        const project = document.getElementById('project-filter').value;
        const category = document.getElementById('category-filter').value;
        const reporter = document.getElementById('reporter-filter').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        const queryParams = new URLSearchParams({
          ...(project && { project }),
          ...(category && { category }),
          ...(reporter && { reporter }),
          ...(startDate && { startDate }),
          ...(endDate && { endDate })
        });

        const response = await fetch(`${API_CONFIG.BASE_URL}/admin/reports/export?${queryParams}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem(AUTH_KEY)}`
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'reports.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        showError('导出失败：' + error.message);
      } finally {
        hideLoading();
      }
    });

    // 关闭模态框
    document.getElementById('close-modal').addEventListener('click', () => {
      document.getElementById('report-modal').classList.add('hidden');
    });

    // 退出登录
    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem(AUTH_KEY);
      document.getElementById('main-content').classList.add('hidden');
      document.getElementById('login-page').classList.remove('hidden');
    });

    // 显示加载中
    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
    }

    // 隐藏加载中
    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    // 显示错误信息
    function showError(message) {
      const errorDiv = document.getElementById('login-error');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => {
        errorDiv.classList.add('hidden');
      }, 5000);
    }

    // 初始化
    if (localStorage.getItem(AUTH_KEY)) {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
      loadReports();
    }
  </script>
</body>
</html>
